#!/usr/bin/env ruby

require 'fileutils'
require 'yaml'

class Airu
  RULES_DIR = File.expand_path('./.airu/rules')
  
  def initialize
    FileUtils.mkdir_p(RULES_DIR) unless Dir.exist?(RULES_DIR)
  end

  def run(args)
    if args.empty?
      # 引数なしの場合はinstallを実行
      install
      return
    end

    command = args.shift
    
    case command
    when 'install'
      install
    when 'init'
      init
    when 'update'
      update
    when 'list'
      list
    when '-h', '--help', 'help'
      help
    else
      puts "不明なコマンド: #{command}"
      help
    end
  end

  def init
    puts "AIルール設定ファイルを初期化しています..."
    
    if File.exist?('.airu')
      puts "警告: .airuファイルが既に存在します。上書きしますか？ [y/N]"
      response = gets.chomp.downcase
      return unless response == 'y'
    end
    
    # デフォルトの.airuファイルを作成
    File.open('.airu', 'w') do |f|
      f.puts "# AIルール設定ファイル"
      f.puts "# 各行に使用するルールを記述してください"
      f.puts "# 例:"
      f.puts "# project-rule"
      f.puts "# command-rule"
    end
    
    puts ".airuファイルを作成しました。"
    puts "必要に応じてルールを編集してください。"
  end

  def install
    puts "AIルールをインストールしています..."
    
    # .airuファイルの存在確認
    unless File.exist?('.airu')
      puts "エラー: .airuファイルが見つかりません。"
      puts "airu initコマンドを実行して.airuファイルを作成してください。"
      return
    end
    
    # .airuファイルからルールを読み込む
    rules = []
    File.readlines('.airu').each do |line|
      line = line.strip
      next if line.empty? || line.start_with?('#')
      rules << line
    end
    
    if rules.empty?
      puts "警告: .airuファイルにルールが指定されていません。"
      return
    end
    
    # ルールをインストール
    rules.each do |rule|
      install_rule(rule)
    end
    
    puts "インストール完了！"
  end

  def install_rule(rule_name)
    puts "  ルール '#{rule_name}' をインストールしています..."
    
    # ルールの存在確認
    rule_dir = File.join(RULES_DIR, rule_name)
    unless Dir.exist?(rule_dir)
      puts "  エラー: ルール '#{rule_name}' が見つかりません。"
      puts "  #{RULES_DIR} ディレクトリにルールが存在するか確認してください。"
      return false
    end
    
    # プロジェクト内のルール保存先ディレクトリを作成
    project_rules_dir = File.join(Dir.pwd, '.cursor', 'rules')
    FileUtils.mkdir_p(project_rules_dir) unless Dir.exist?(project_rules_dir)
    
    # ルールファイルのコピー
    rule_files = Dir.glob(File.join(rule_dir, '**', '*'))
    if rule_files.empty?
      puts "  警告: ルール '#{rule_name}' にファイルが見つかりません。"
      return false
    end
    
    # ルールファイルの保存先パス
    target_file = File.join(project_rules_dir, "#{rule_name}.mdc")
    
    # ルールファイルをコピー
    begin
      # rule.mdファイルを探す
      rule_md_file = rule_files.find { |f| File.basename(f) == 'rule.md' }
      
      if rule_md_file
        FileUtils.cp(rule_md_file, target_file)
        puts "  ルール '#{rule_name}' を #{target_file} にインストールしました。"
        return true
      else
        # rule.mdがない場合は最初のファイルをコピー
        FileUtils.cp(rule_files.first, target_file)
        puts "  ルール '#{rule_name}' を #{target_file} にインストールしました。"
        puts "  警告: rule.mdファイルが見つからなかったため、別のファイルをコピーしました。"
        return true
      end
    rescue => e
      puts "  エラー: ルール '#{rule_name}' のインストール中にエラーが発生しました: #{e.message}"
      return false
    end
  end

  def update
    puts "AIルールを更新しています..."
    # TODO: 実際の更新ロジックを実装
    puts "更新完了！"
  end

  def list
    puts "インストール済みのAIルール:"
    # TODO: インストール済みルールの一覧表示ロジックを実装
    if Dir.empty?(RULES_DIR)
      puts "  インストール済みのルールはありません。"
    end
  end

  def help
    puts <<~HELP
      airu - AIルールマネージャー

      使い方:
        airu                AIルールをインストールします
        airu [コマンド]

      コマンド:
        init                .airuファイルを作成します
        install             AIルールをインストールします
        update              AIルールを更新します
        list                インストール済みのAIルールを表示します
        -h, --help, help    このヘルプを表示します

      詳細は https://github.com/s4na/homebrew-airu を参照してください。
    HELP
  end
end

# スクリプトとして実行された場合のみ実行
if __FILE__ == $0
  Airu.new.run(ARGV)
end 
